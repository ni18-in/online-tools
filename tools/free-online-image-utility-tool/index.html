<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Free Online Image Utility Tool | Resize, Compress & Convert Images</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <meta name="description"
        content="Use our free online image utility tool to quickly resize, compress, convert, and optimize images. No downloads required. Fast, secure, and browser-based.">

    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
    <link rel="manifest" href="/assets/icons/site.webmanifest">

    <meta property="og:title" content="Free Online Image Utility Tool | Resize, Compress & Convert">
    <meta property="og:description"
        content="A powerful free web app for resizing, compressing, and converting images instantly. Simple, fast, and secure.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://online-tools.ni18.in/tools/free-online-image-utility-tool">
    <meta property="og:site_name" content="Online Tools">
    <meta property="og:locale" content="en_US">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Free Online Image Utility Tool | Resize, Compress & Convert">
    <meta name="twitter:description"
        content="Quickly resize, compress, and convert your images online for free. No login or installation needed.">

    <link rel="canonical" href="https://online-tools.ni18.in/tools/free-online-image-utility-tool">

    <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "Free Online Image Utility Tool",
  "operatingSystem": "Web",
  "applicationCategory": "MultimediaApplication",
  "offers": {
    "@type": "Offer",
    "price": "0.00",
    "priceCurrency": "USD"
  },
  "url": "https://online-tools.ni18.in/tools/free-online-image-utility-tool",
  "description": "A browser-based image tool that allows you to resize, compress, convert, and optimize images online for free."
}
</script>


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@latest/font/Lucide.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .file-input-label {
            cursor: pointer;
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            text-align: center;
        }

        .file-input-label:hover {
            background-color: #f1f5f9;
            border-color: #94a3b8;
        }

        input[type="file"] {
            display: none;
        }

        /* Canvas Styling */
        #canvas-container {
            /* Added container */
            position: relative;
            /* Needed for Cropper overlay */
            max-width: 100%;
            margin: 0 auto;
            line-height: 0;
            /* Prevent extra space below canvas/img */
        }

        canvas,
        #cropper-image {
            /* Apply to both canvas and cropper image */
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
            background-color: #e2e8f0;
            background-image: linear-gradient(45deg, #f1f5f9 25%, transparent 25%), linear-gradient(-45deg, #f1f5f9 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f1f5f9 75%), linear-gradient(-45deg, transparent 75%, #f1f5f9 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border-radius: 0.375rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        #cropper-image {
            display: none;
        }

        /* Hide img initially */

        /* Cropper.js specific overrides if needed */
        .cropper-view-box,
        .cropper-face {
            border-radius: 0.25rem;
        }

        .tool-button.active {
            background-color: #3b82f6;
            color: white;
        }

        .lucide {
            vertical-align: middle;
            display: inline-block;
            width: 1.1em;
            height: 1.1em;
            margin-right: 0.35rem;
            stroke-width: 2;
        }

        button .lucide {
            width: 1em;
            height: 1em;
        }

        #header-actions button .lucide {
            margin-right: 0.15rem;
            width: 1.1em;
            height: 1.1em;
        }

        #message-box {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            z-index: 50;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            max-width: 90%;
        }

        #message-box.show {
            display: block;
            opacity: 1;
        }

        #message-box.success {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        #message-box.error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        #message-box.info {
            background-color: #e0f2fe;
            color: #075985;
            border: 1px solid #7dd3fc;
        }

        .options-section,
        #export-panel {
            display: none;
        }

        .options-section.active,
        #export-panel.active {
            display: block;
        }

        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 0.375rem;
            display: none;
            pointer-events: none;
        }

        #loading-overlay.show {
            display: flex;
            pointer-events: auto;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        input[type="range"] {
            height: 0.5rem;
            background-color: #e2e8f0;
            border-radius: 9999px;
            appearance: none;
            cursor: pointer;
            width: 100%;
        }

        /* Ensure width */
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 1rem;
            height: 1rem;
            background-color: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 1rem;
            height: 1rem;
            background-color: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        /* Style for canvas when text tool is active */
        canvas.text-tool-active {
            cursor: crosshair;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">

    <header class="bg-white shadow-sm p-4 sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-blue-600">Free Online Image Utility Tool</h1>
            <div id="header-actions" class="flex items-center gap-3">
                <button id="undo-btn"
                    class="text-sm text-slate-600 hover:text-blue-600 transition-colors disabled:text-slate-400 disabled:hover:text-slate-400"
                    title="Undo last action" disabled>
                    <i class="lucide lucide-undo-2"></i> Undo
                </button>
                <button id="redo-btn"
                    class="text-sm text-slate-600 hover:text-blue-600 transition-colors disabled:text-slate-400 disabled:hover:text-slate-400"
                    title="Redo last undone action" disabled>
                    <i class="lucide lucide-redo-2"></i> Redo
                </button>
                <span class="text-slate-300">|</span>
                <button id="reset-all-btn" class="text-sm text-slate-600 hover:text-red-600 transition-colors"
                    title="Clear image and reset all settings">
                    <i class="lucide lucide-trash-2"></i> Clear All
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6 lg:p-8 flex flex-col lg:flex-row gap-6 lg:gap-8">

        <aside class="w-full lg:w-1/4 space-y-6">
            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-3 border-b pb-2">1. Upload Image</h2>
                <label for="file-input" class="file-input-label block w-full">
                    <i class="lucide lucide-upload-cloud text-4xl text-slate-400 mx-auto mb-2"></i>
                    <span class="text-slate-600 font-medium">Click or Drag & Drop</span>
                    <p class="text-xs text-slate-500 mt-1">Supports JPG, PNG, WEBP</p>
                </label>
                <input type="file" id="file-input" accept="image/jpeg, image/png, image/webp">
                <div id="file-info" class="text-xs text-slate-500 mt-3 space-y-1">
                    <p>Filename: <span id="info-filename">N/A</span></p>
                    <p>Original Size: <span id="info-orig-size">N/A</span></p>
                    <p>Original Dimensions: <span id="info-orig-dims">N/A</span></p>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-3 border-b pb-2">2. Tools</h2>
                <div class="grid grid-cols-2 gap-3">
                    <button
                        class="tool-button p-2 border rounded-md hover:bg-slate-100 transition-colors text-sm flex items-center justify-center"
                        data-tool="resize"><i class="lucide lucide-move-horizontal"></i> Resize</button>
                    <button
                        class="tool-button p-2 border rounded-md hover:bg-slate-100 transition-colors text-sm flex items-center justify-center"
                        data-tool="crop"><i class="lucide lucide-crop"></i> Crop</button>
                    <button
                        class="tool-button p-2 border rounded-md hover:bg-slate-100 transition-colors text-sm flex items-center justify-center"
                        data-tool="rotate"><i class="lucide lucide-rotate-cw"></i> Rotate</button>
                    <button
                        class="tool-button p-2 border rounded-md hover:bg-slate-100 transition-colors text-sm flex items-center justify-center"
                        data-tool="flip"><i class="lucide lucide-flip-horizontal-2"></i> Flip</button>
                    <button
                        class="tool-button p-2 border rounded-md hover:bg-slate-100 transition-colors text-sm flex items-center justify-center"
                        data-tool="adjust"><i class="lucide lucide-sliders-horizontal"></i> Adjust</button>
                    <button
                        class="tool-button p-2 border rounded-md hover:bg-slate-100 transition-colors text-sm flex items-center justify-center"
                        data-tool="border"><i class="lucide lucide-square"></i> Border</button>
                    <button
                        class="tool-button p-2 border rounded-md hover:bg-slate-100 transition-colors text-sm flex items-center justify-center"
                        data-tool="text"><i class="lucide lucide-type"></i> Text</button>
                </div>
            </div>
        </aside>

        <section class="w-full lg:w-1/2 relative">
            <div class="bg-white p-4 rounded-lg shadow sticky top-[80px]">
                <h2 class="text-lg font-semibold mb-3 border-b pb-2">Preview</h2>
                <div id="preview-area"
                    class="relative min-h-[200px] flex items-center justify-center bg-slate-100 rounded-md overflow-hidden">
                    <div id="canvas-container">
                        <canvas id="canvas"></canvas>
                        <img id="cropper-image" alt="Image for cropping">
                    </div>
                    <p id="preview-placeholder"
                        class="text-slate-500 p-5 text-center absolute inset-0 flex items-center justify-center">Upload
                        an image to start editing</p>
                    <div id="loading-overlay">
                        <div class="spinner"></div>
                    </div>
                </div>
                <div id="image-details" class="text-sm text-slate-600 mt-3 space-y-1">
                    <p>Current Dimensions: <span id="img-dimensions">N/A</span></p>
                </div>
            </div>
        </section>

        <aside class="w-full lg:w-1/4 space-y-6">
            <div id="options-panel-container" class="bg-white p-4 rounded-lg shadow min-h-[200px]">
                <h2 class="text-lg font-semibold mb-3 border-b pb-2">3. Tool Options</h2>
                <div id="options-placeholder" class="text-slate-500 text-sm">Select a tool to see its options.</div>

                <div id="options-resize" class="options-section space-y-3">
                    <label class="block text-sm font-medium text-slate-700">Dimensions (px)</label>
                    <div class="flex gap-2 items-center">
                        <input type="number" id="resize-width" placeholder="Width"
                            class="form-input w-full text-sm rounded-md border-slate-300">
                        <span class="text-slate-500">x</span>
                        <input type="number" id="resize-height" placeholder="Height"
                            class="form-input w-full text-sm rounded-md border-slate-300">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="resize-aspect-ratio" checked
                            class="form-checkbox rounded text-blue-600">
                        <label for="resize-aspect-ratio" class="ml-2 text-sm text-slate-600">Lock Aspect Ratio</label>
                    </div>
                    <button id="apply-resize-btn"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors text-sm">Apply
                        Resize</button>
                    <p class="text-xs text-slate-500">Live preview active. Uses browser default scaling.</p>
                </div>

                <div id="options-crop" class="options-section space-y-3">
                    <p class="text-xs text-slate-500 mb-2">Drag handles to adjust crop area.</p>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Aspect Ratio</label>
                        <div class="flex flex-wrap gap-2 mt-1">
                            <button class="crop-aspect-btn text-xs border px-2 py-1 rounded hover:bg-slate-100"
                                data-ratio="free">Free</button>
                            <button class="crop-aspect-btn text-xs border px-2 py-1 rounded hover:bg-slate-100"
                                data-ratio="1/1">1:1</button>
                            <button class="crop-aspect-btn text-xs border px-2 py-1 rounded hover:bg-slate-100"
                                data-ratio="4/3">4:3</button>
                            <button class="crop-aspect-btn text-xs border px-2 py-1 rounded hover:bg-slate-100"
                                data-ratio="16/9">16:9</button>
                            <button class="crop-aspect-btn text-xs border px-2 py-1 rounded hover:bg-slate-100"
                                data-ratio="orig">Original</button>
                        </div>
                    </div>
                    <button id="apply-crop-btn"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors text-sm mt-2">Apply
                        Crop</button>
                    <button id="cancel-crop-btn"
                        class="w-full bg-slate-500 text-white py-2 px-4 rounded-md hover:bg-slate-600 transition-colors text-sm mt-2">Cancel
                        Crop</button>
                </div>

                <div id="options-rotate" class="options-section space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <button id="rotate-left-btn"
                            class="p-2 border rounded-md hover:bg-slate-100 transition-colors text-sm flex items-center justify-center"><i
                                class="lucide lucide-rotate-ccw"></i> 90° Left</button>
                        <button id="rotate-right-btn"
                            class="p-2 border rounded-md hover:bg-slate-100 transition-colors text-sm flex items-center justify-center"><i
                                class="lucide lucide-rotate-cw"></i> 90° Right</button>
                    </div>
                </div>

                <div id="options-flip" class="options-section space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <button id="flip-horizontal-btn"
                            class="p-2 border rounded-md hover:bg-slate-100 transition-colors text-sm flex items-center justify-center"><i
                                class="lucide lucide-flip-horizontal"></i> Horizontal</button>
                        <button id="flip-vertical-btn"
                            class="p-2 border rounded-md hover:bg-slate-100 transition-colors text-sm flex items-center justify-center"><i
                                class="lucide lucide-flip-vertical"></i> Vertical</button>
                    </div>
                </div>

                <div id="options-adjust" class="options-section space-y-4">
                    <div>
                        <label for="brightness-slider" class="block text-sm font-medium text-slate-700 mb-1">Brightness
                            (<span id="brightness-value">100</span>%)</label>
                        <input type="range" id="brightness-slider" min="0" max="200" value="100"
                            class="w-full form-range">
                    </div>
                    <div>
                        <label for="contrast-slider" class="block text-sm font-medium text-slate-700 mb-1">Contrast
                            (<span id="contrast-value">100</span>%)</label>
                        <input type="range" id="contrast-slider" min="0" max="200" value="100"
                            class="w-full form-range">
                    </div>
                    <div>
                        <label for="saturation-slider" class="block text-sm font-medium text-slate-700 mb-1">Saturation
                            (<span id="saturation-value">100</span>%)</label>
                        <input type="range" id="saturation-slider" min="0" max="200" value="100"
                            class="w-full form-range">
                    </div>
                    <div>
                        <label for="grayscale-slider" class="block text-sm font-medium text-slate-700 mb-1">Grayscale
                            (<span id="grayscale-value">0</span>%)</label>
                        <input type="range" id="grayscale-slider" min="0" max="100" value="0" class="w-full form-range">
                    </div>
                    <div>
                        <label for="sepia-slider" class="block text-sm font-medium text-slate-700 mb-1">Sepia (<span
                                id="sepia-value">0</span>%)</label>
                        <input type="range" id="sepia-slider" min="0" max="100" value="0" class="w-full form-range">
                    </div>
                    <div>
                        <label for="blur-slider" class="block text-sm font-medium text-slate-700 mb-1">Blur (<span
                                id="blur-value">0</span>px)</label>
                        <input type="range" id="blur-slider" min="0" max="10" step="0.1" value="0"
                            class="w-full form-range">
                    </div>
                    <button id="apply-adjust-btn"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors text-sm">Apply
                        Adjustments</button>
                    <button id="reset-adjust-btn"
                        class="w-full bg-slate-500 text-white py-2 px-4 rounded-md hover:bg-slate-600 transition-colors text-sm mt-2">Reset
                        Adjustments</button>
                </div>

                <div id="options-border" class="options-section space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label for="border-width" class="block text-sm font-medium text-slate-700">Width
                                (px)</label>
                            <input type="number" id="border-width" value="5" min="0"
                                class="form-input w-full text-sm rounded-md border-slate-300">
                        </div>
                        <div>
                            <label for="border-color" class="block text-sm font-medium text-slate-700">Color</label>
                            <input type="color" id="border-color" value="#000000"
                                class="form-input w-full h-10 text-sm rounded-md border-slate-300 p-1">
                        </div>
                    </div>
                    <button id="apply-border-btn"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors text-sm">Apply
                        Border</button>
                    <p class="text-xs text-slate-500">Live preview active.</p>
                </div>


                <div id="options-text" class="options-section space-y-3">
                    <p class="text-xs text-slate-500 mb-2">Click on the preview to position text, then adjust options.
                    </p>
                    <label for="text-input" class="block text-sm font-medium text-slate-700">Text</label>
                    <textarea id="text-input" placeholder="Your text here" rows="3"
                        class="form-textarea w-full text-sm rounded-md border-slate-300"></textarea>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label for="text-font-family" class="block text-sm font-medium text-slate-700">Font</label>
                            <select id="text-font-family"
                                class="form-select w-full text-sm rounded-md border-slate-300">
                                <option value="Arial, sans-serif">Arial</option>
                                <option value="Verdana, sans-serif">Verdana</option>
                                <option value="'Times New Roman', Times, serif">Times New Roman</option>
                                <option value="'Courier New', Courier, monospace">Courier New</option>
                                <option value="Georgia, serif">Georgia</option>
                                <option value="Impact, Charcoal, sans-serif">Impact</option>
                            </select>
                        </div>
                        <div>
                            <label for="text-size" class="block text-sm font-medium text-slate-700">Size (px)</label>
                            <input type="number" id="text-size" value="30" min="8"
                                class="form-input w-full text-sm rounded-md border-slate-300">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Style</label>
                            <div class="flex gap-2 mt-1">
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" id="text-bold"
                                        class="form-checkbox rounded text-blue-600 mr-1"> Bold
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="checkbox" id="text-italic"
                                        class="form-checkbox rounded text-blue-600 mr-1"> Italic
                                </label>
                            </div>
                        </div>
                        <div>
                            <label for="text-color" class="block text-sm font-medium text-slate-700">Color</label>
                            <input type="color" id="text-color" value="#ffffff"
                                class="form-input w-full h-10 text-sm rounded-md border-slate-300 p-1">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label for="text-align" class="block text-sm font-medium text-slate-700">Align</label>
                            <select id="text-align" class="form-select w-full text-sm rounded-md border-slate-300">
                                <option value="left">Left</option>
                                <option value="center">Center</option>
                                <option value="right">Right</option>
                            </select>
                        </div>
                        <div>
                            <label for="text-rotation" class="block text-sm font-medium text-slate-700">Rotation
                                (°)</label>
                            <input type="number" id="text-rotation" value="0" step="1"
                                class="form-input w-full text-sm rounded-md border-slate-300">
                        </div>
                    </div>

                    <div>
                        <label for="text-opacity" class="block text-sm font-medium text-slate-700 mb-1">Opacity (<span
                                id="text-opacity-value">0.7</span>)</label>
                        <input type="range" id="text-opacity" min="0" max="1" step="0.05" value="0.7"
                            class="w-full form-range">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label for="text-x" class="block text-sm font-medium text-slate-700">X Position</label>
                            <input type="number" id="text-x" value="50" step="1"
                                class="form-input w-full text-sm rounded-md border-slate-300">
                        </div>
                        <div>
                            <label for="text-y" class="block text-sm font-medium text-slate-700">Y Position</label>
                            <input type="number" id="text-y" value="50" step="1"
                                class="form-input w-full text-sm rounded-md border-slate-300">
                        </div>
                    </div>
                    <p class="text-xs text-slate-500">X/Y position is relative to the top-left corner.</p>

                    <button id="apply-text-btn"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors text-sm">Apply
                        Text</button>
                    <p class="text-xs text-slate-500">Live preview active.</p>
                </div>

            </div>

            <div id="export-panel" class="bg-white p-4 rounded-lg shadow space-y-3">
                <h2 class="text-lg font-semibold mb-3 border-b pb-2">4. Export Image</h2>
                <div>
                    <label for="convert-format" class="block text-sm font-medium text-slate-700">Output Format</label>
                    <select id="convert-format" class="form-select w-full text-sm rounded-md border-slate-300 mt-1">
                        <option value="image/png">PNG (Lossless)</option>
                        <option value="image/jpeg">JPG (Lossy)</option>
                        <option value="image/webp">WEBP (Lossy/Lossless)</option>
                    </select>
                </div>
                <div id="quality-option" class="space-y-1 hidden">
                    <label for="convert-quality" class="block text-sm font-medium text-slate-700 mb-1">Quality (<span
                            id="quality-value">92</span>%)</label>
                    <input type="range" id="convert-quality" min="1" max="100" value="92" class="w-full form-range">
                    <p class="text-xs text-slate-500">Lower quality means smaller file size (for JPG/WEBP).</p>
                </div>
                <div id="webp-options" class="space-y-1 hidden">
                    <div class="flex items-center">
                        <input type="checkbox" id="webp-lossless" class="form-checkbox rounded text-blue-600">
                        <label for="webp-lossless" class="ml-2 text-sm text-slate-600">Use Lossless WEBP</label>
                    </div>
                </div>
                <div>
                    <label for="download-filename" class="block text-sm font-medium text-slate-700">Filename</label>
                    <input type="text" id="download-filename" value="edited-image"
                        class="form-input w-full text-sm rounded-md border-slate-300 mt-1">
                </div>
                <div class="text-sm text-slate-600">
                    Estimated Size: <span id="estimated-size" class="font-medium">N/A</span>
                </div>
                <button id="download-btn"
                    class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors text-sm flex items-center justify-center gap-2">
                    <i class="lucide lucide-download"></i> Download Image
                </button>
            </div>

        </aside>

    </main>

    <div id="message-box">
        <span id="message-text"></span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script>
        // --- DOM Elements ---
        const fileInput = document.getElementById('file-input');
        const fileInputLabel = document.querySelector('.file-input-label');
        const fileInfoDiv = document.getElementById('file-info');
        const infoFilename = document.getElementById('info-filename');
        const infoOrigSize = document.getElementById('info-orig-size');
        const infoOrigDims = document.getElementById('info-orig-dims');

        const canvasContainer = document.getElementById('canvas-container'); // New
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const cropperImage = document.getElementById('cropper-image'); // New for Cropper.js
        const previewPlaceholder = document.getElementById('preview-placeholder');
        const imgDimensions = document.getElementById('img-dimensions');
        const toolButtons = document.querySelectorAll('.tool-button');
        const optionsPanelContainer = document.getElementById('options-panel-container');
        const optionsPlaceholder = document.getElementById('options-placeholder');
        const allOptionsSections = document.querySelectorAll('.options-section');
        const loadingOverlay = document.getElementById('loading-overlay');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');

        // Header Buttons
        const resetAllBtn = document.getElementById('reset-all-btn');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');

        // Resize Elements
        const resizeWidthInput = document.getElementById('resize-width');
        const resizeHeightInput = document.getElementById('resize-height');
        const resizeAspectRatioCheckbox = document.getElementById('resize-aspect-ratio');
        const applyResizeBtn = document.getElementById('apply-resize-btn');

        // Crop Elements
        const cropOptionsDiv = document.getElementById('options-crop'); // Get the whole div
        const applyCropBtn = document.getElementById('apply-crop-btn');
        const cancelCropBtn = document.getElementById('cancel-crop-btn'); // New
        const cropAspectBtns = document.querySelectorAll('.crop-aspect-btn'); // New

        // Rotate Elements
        const rotateLeftBtn = document.getElementById('rotate-left-btn');
        const rotateRightBtn = document.getElementById('rotate-right-btn');

        // Flip Elements
        const flipHorizontalBtn = document.getElementById('flip-horizontal-btn');
        const flipVerticalBtn = document.getElementById('flip-vertical-btn');

        // Adjust Elements
        const brightnessSlider = document.getElementById('brightness-slider');
        const contrastSlider = document.getElementById('contrast-slider');
        const saturationSlider = document.getElementById('saturation-slider');
        const grayscaleSlider = document.getElementById('grayscale-slider');
        const sepiaSlider = document.getElementById('sepia-slider');
        const blurSlider = document.getElementById('blur-slider');
        const brightnessValue = document.getElementById('brightness-value');
        const contrastValue = document.getElementById('contrast-value');
        const saturationValue = document.getElementById('saturation-value');
        const grayscaleValue = document.getElementById('grayscale-value');
        const sepiaValue = document.getElementById('sepia-value');
        const blurValue = document.getElementById('blur-value');
        const applyAdjustBtn = document.getElementById('apply-adjust-btn');
        const resetAdjustBtn = document.getElementById('reset-adjust-btn');

        // Border Elements
        const borderWidthInput = document.getElementById('border-width');
        const borderColorInput = document.getElementById('border-color');
        const applyBorderBtn = document.getElementById('apply-border-btn');

        // Text Tool Elements
        const textInput = document.getElementById('text-input');
        const textFontFamilySelect = document.getElementById('text-font-family');
        const textSizeInput = document.getElementById('text-size');
        const textBoldCheckbox = document.getElementById('text-bold');
        const textItalicCheckbox = document.getElementById('text-italic');
        const textColorInput = document.getElementById('text-color');
        const textAlignSelect = document.getElementById('text-align');
        const textRotationInput = document.getElementById('text-rotation');
        const textOpacitySlider = document.getElementById('text-opacity');
        const textOpacityValue = document.getElementById('text-opacity-value');
        const textXInput = document.getElementById('text-x'); // New
        const textYInput = document.getElementById('text-y'); // New
        // const textPositionSelect = document.getElementById('text-position'); // Removed
        const applyTextBtn = document.getElementById('apply-text-btn');

        // Export Panel Elements
        const exportPanel = document.getElementById('export-panel');
        const convertFormatSelect = document.getElementById('convert-format');
        const qualityOptionDiv = document.getElementById('quality-option');
        const convertQualitySlider = document.getElementById('convert-quality');
        const qualityValue = document.getElementById('quality-value');
        const webpOptionsDiv = document.getElementById('webp-options');
        const webpLosslessCheckbox = document.getElementById('webp-lossless');
        const downloadFilenameInput = document.getElementById('download-filename');
        const estimatedSizeSpan = document.getElementById('estimated-size');
        const downloadBtn = document.getElementById('download-btn');


        // --- State Variables ---
        let originalImage = null; // Stores the original uploaded Image object
        let currentImage = null; // Stores the *current* Image object (after last apply/undo/redo)
        let originalFileData = { name: null, size: 0 };
        let originalWidth = 0; let originalHeight = 0;
        let currentWidth = 0; let currentHeight = 0;
        let currentAspectRatio = 1;
        let activeTool = null;
        let isProcessing = false;
        let isHistoryNavigation = false;
        let debounceTimer = null;
        let cropperInstance = null; // To hold the Cropper.js instance

        // History
        let historyStack = [];
        let historyIndex = -1;
        const MAX_HISTORY = 20;

        // --- Utility Functions ---
        function debounce(func, delay) { clearTimeout(debounceTimer); debounceTimer = setTimeout(func, delay); }
        function showLoading(show) { isProcessing = show; loadingOverlay.classList.toggle('show', show); }
        function showMessage(message, type = 'info', duration = 3000) { /* ... (no changes) ... */ messageText.textContent = message; messageBox.className = `show ${type}`; if (messageBox.timeoutId) clearTimeout(messageBox.timeoutId); messageBox.timeoutId = setTimeout(() => { messageBox.classList.remove('show'); messageBox.timeoutId = null; }, duration); }
        function formatBytes(bytes, decimals = 1) { /* ... (no changes) ... */ if (!bytes || bytes === 0) return '0 Bytes'; const k = 1024; const dm = decimals < 0 ? 0 : decimals; const sizes = ['Bytes', 'KB', 'MB', 'GB']; const i = (bytes > 0) ? Math.floor(Math.log(bytes) / Math.log(k)) : 0; return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i]; }

        // --- History Functions ---
        function updateHistoryButtons() { undoBtn.disabled = historyIndex <= 0; redoBtn.disabled = historyIndex >= historyStack.length - 1; }
        function pushHistoryState() {
            if (isHistoryNavigation || !currentImage) return;
            const tempCanvas = document.createElement('canvas'); const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = currentWidth; tempCanvas.height = currentHeight;
            try {
                tempCtx.drawImage(currentImage, 0, 0, currentWidth, currentHeight);
                const dataUrl = tempCanvas.toDataURL('image/png');
                if (historyIndex < historyStack.length - 1) historyStack = historyStack.slice(0, historyIndex + 1);
                historyStack.push(dataUrl);
                if (historyStack.length > MAX_HISTORY) historyStack.shift();
                historyIndex = historyStack.length - 1;
            } catch (error) { console.error("Error generating data URL for history:", error); showMessage("Failed to save history state.", "error"); return; }
            updateHistoryButtons();
        }
        function loadHistoryState(index) {
            if (index < 0 || index >= historyStack.length || isProcessing) return;
            isHistoryNavigation = true; showLoading(true);
            const dataUrl = historyStack[index]; const img = new Image();
            img.onload = () => {
                currentImage = img; currentWidth = img.naturalWidth; currentHeight = img.naturalHeight;
                currentAspectRatio = (currentHeight > 0) ? currentWidth / currentHeight : 1;
                historyIndex = index;
                // Destroy cropper if active before drawing
                if (cropperInstance) destroyCropper();
                drawCurrentImageToCanvas(); // Redraw canvas with the loaded state
                updateEstimatedSize(); updateHistoryButtons(); showLoading(false); isHistoryNavigation = false;
                if (activeTool === 'adjust') resetAdjustmentSliders(false);
                if (activeTool === 'resize') { resizeWidthInput.value = currentWidth; resizeHeightInput.value = currentHeight; }
                // Add resets for other tools if needed
                drawCurrentImageToCanvas(); // Redraw again to clear any lingering previews
            };
            img.onerror = (err) => { console.error("Error loading history state image:", err); showMessage('Error loading history state.', 'error', 5000); showLoading(false); isHistoryNavigation = false; updateHistoryButtons(); };
            img.src = dataUrl;
        }

        function resetAppState() {
            if (cropperInstance) destroyCropper(); // Destroy cropper if exists
            originalImage = null; currentImage = null; originalFileData = { name: null, size: 0 };
            originalWidth = 0; originalHeight = 0; currentWidth = 0; currentHeight = 0;
            currentAspectRatio = 1; activeTool = null;
            historyStack = []; historyIndex = -1; updateHistoryButtons();
            // Clear UI
            infoFilename.textContent = 'N/A'; infoOrigSize.textContent = 'N/A'; infoOrigDims.textContent = 'N/A';
            imgDimensions.textContent = 'N/A'; estimatedSizeSpan.textContent = 'N/A';
            previewPlaceholder.style.display = 'block'; canvas.style.display = 'none'; cropperImage.style.display = 'none';
            ctx.clearRect(0, 0, canvas.width, canvas.height); fileInput.value = null;
            // Reset UI elements
            hideAllOptionsPanels(); optionsPlaceholder.style.display = 'block';
            deactivateAllToolButtons(); exportPanel.classList.remove('active');
            // Reset tool inputs
            resizeWidthInput.value = ''; resizeHeightInput.value = ''; resizeAspectRatioCheckbox.checked = true;
            // Crop inputs removed
            resetAdjustmentSliders(false);
            borderWidthInput.value = 5; borderColorInput.value = '#000000';
            textInput.value = ''; textFontFamilySelect.value = 'Arial, sans-serif'; textSizeInput.value = 30;
            textBoldCheckbox.checked = false; textItalicCheckbox.checked = false; textColorInput.value = '#ffffff';
            textAlignSelect.value = 'left'; textRotationInput.value = 0; // Default align left for X/Y
            textOpacitySlider.value = 0.7; textOpacityValue.textContent = '0.7';
            textXInput.value = 10; textYInput.value = 10; // Default X/Y
            convertFormatSelect.value = 'image/png'; convertQualitySlider.value = 92; qualityValue.textContent = '92';
            downloadFilenameInput.value = 'edited-image'; qualityOptionDiv.classList.add('hidden'); webpOptionsDiv.classList.add('hidden');
            showLoading(false);
        }

        function updateImageDetails(width, height) {
            // Update canvas size only if not cropping
            if (activeTool !== 'crop') {
                if (canvas.width !== width || canvas.height !== height) {
                    canvas.width = width; canvas.height = height;
                }
            }
            imgDimensions.textContent = `${width} x ${height} px`;
        }

        // --- Cropper.js Functions ---
        function initializeCropper() {
            if (!currentImage || cropperInstance) return;
            console.log("Initializing Cropper");
            // Use the current committed image data
            cropperImage.src = currentImage.src; // Use the Image object's src
            canvas.style.display = 'none'; // Hide canvas
            cropperImage.style.display = 'block'; // Show image

            // Ensure image is loaded before initializing cropper if src was just set
            // However, currentImage.src should already be loaded dataURL/blobURL
            cropperInstance = new Cropper(cropperImage, {
                viewMode: 1, // restrict crop box to canvas
                dragMode: 'move',
                autoCropArea: 0.8,
                background: false, // Use CSS background
                // responsive: true, // Handled by CSS max-width? Check docs
                // checkOrientation: false, // Assuming orientation handled on upload if needed
                // ready() { console.log("Cropper ready"); }, // Debug
            });
            // Set initial aspect ratio if needed (e.g., free)
            setCropperAspectRatio('free');
        }

        function destroyCropper() {
            if (cropperInstance) {
                console.log("Destroying Cropper");
                cropperInstance.destroy();
                cropperInstance = null;
                cropperImage.style.display = 'none'; // Hide image
                canvas.style.display = 'block'; // Show canvas
                // Redraw current state on canvas after destroying cropper
                if (currentImage) drawCurrentImageToCanvas();
            }
        }

        function setCropperAspectRatio(ratio) {
            if (!cropperInstance) return;
            let aspectRatio;
            if (ratio === 'free') aspectRatio = NaN; // Free ratio
            else if (ratio === 'orig') aspectRatio = currentAspectRatio;
            else {
                const parts = ratio.split('/');
                aspectRatio = parseFloat(parts[0]) / parseFloat(parts[1]);
            }
            cropperInstance.setAspectRatio(aspectRatio);
        }


        // --- Core Drawing and State Update ---
        function drawCurrentImageToCanvas() {
            // If cropper is active, don't draw on main canvas
            if (cropperInstance) return;

            if (!currentImage) { console.warn("drawCurrentImageToCanvas called with no currentImage."); return; }
            updateImageDetails(currentWidth, currentHeight);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.filter = 'none'; ctx.globalAlpha = 1.0; ctx.strokeStyle = 'transparent';

            let filters = 'none';
            if (activeTool === 'adjust') { filters = [`brightness(${brightnessSlider.value}%)`, `contrast(${contrastSlider.value}%)`, `saturate(${saturationSlider.value}%)`, `grayscale(${grayscaleSlider.value}%)`, `sepia(${sepiaSlider.value}%)`, `blur(${blurSlider.value}px)`].join(' '); }
            ctx.filter = filters;

            try { ctx.drawImage(currentImage, 0, 0, currentWidth, currentHeight); }
            catch (e) { console.error("Error drawing image:", e); showMessage("Error displaying preview.", "error", 5000); previewPlaceholder.style.display = 'block'; canvas.style.display = 'none'; showLoading(false); return; }
            ctx.filter = 'none';

            if (activeTool === 'border') {
                const borderWidth = parseInt(borderWidthInput.value, 10);
                if (!isNaN(borderWidth) && borderWidth > 0) { ctx.strokeStyle = borderColorInput.value; ctx.lineWidth = borderWidth; ctx.strokeRect(borderWidth / 2, borderWidth / 2, currentWidth - borderWidth, currentHeight - borderWidth); }
            }
            if (activeTool === 'text') { const text = textInput.value; if (text) drawText(ctx, text, currentWidth, currentHeight); }

            previewPlaceholder.style.display = 'none'; canvas.style.display = 'block';
        }

        function updateCurrentImageFromDataURL(dataUrl, callback) {
            // Destroy cropper if active before updating main image
            if (cropperInstance) destroyCropper();

            showLoading(true);
            const img = new Image();
            img.onload = () => {
                currentImage = img; currentWidth = img.naturalWidth; currentHeight = img.naturalHeight;
                currentAspectRatio = (currentHeight > 0) ? currentWidth / currentHeight : 1;
                drawCurrentImageToCanvas(); // Redraw canvas with the new image
                pushHistoryState(); // Push history *after* successful update and redraw
                updateEstimatedSize(); showLoading(false);
                if (callback) callback();
            };
            img.onerror = (err) => { console.error("Error loading image object:", err); showMessage('Error processing applied changes.', 'error', 5000); showLoading(false); };
            img.src = dataUrl;
        }


        // --- Event Handlers ---
        function handleFileSelect(file) {
            if (!file || !file.type.startsWith('image/')) { showMessage('Invalid image file.', 'error'); return; }
            if (isProcessing) return;
            resetAppState(); showLoading(true);
            originalFileData = { name: file.name, size: file.size };
            const reader = new FileReader();
            reader.onload = (e) => {
                const imageDataUrl = e.target.result;
                infoFilename.textContent = originalFileData.name; infoOrigSize.textContent = formatBytes(originalFileData.size);
                const img = new Image();
                img.onload = () => {
                    originalImage = img; currentImage = img;
                    originalWidth = img.naturalWidth; originalHeight = img.naturalHeight;
                    currentWidth = originalWidth; currentHeight = originalHeight;
                    currentAspectRatio = (currentHeight > 0) ? currentWidth / currentHeight : 1;
                    infoOrigDims.textContent = `${originalWidth} x ${originalHeight} px`;
                    drawCurrentImageToCanvas(); pushHistoryState(); // Save initial state
                    showMessage('Image loaded.', 'success'); exportPanel.classList.add('active');
                    updateEstimatedSize(); showLoading(false);
                };
                img.onerror = (err) => { console.error("Error loading initial image object:", err); showMessage('Could not load image.', 'error', 5000); resetAppState(); showLoading(false); };
                img.src = imageDataUrl;
            };
            reader.onerror = (err) => { console.error("FileReader error:", err); showMessage('Error reading file.', 'error', 5000); resetAppState(); showLoading(false); };
            reader.readAsDataURL(file);
        }
        fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFileSelect(e.target.files[0]); });
        // Drag and Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { fileInputLabel.addEventListener(eventName, preventDefaults, false); document.body.addEventListener(eventName, preventDefaults, false); });
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        ['dragenter', 'dragover'].forEach(eventName => { fileInputLabel.addEventListener(eventName, () => fileInputLabel.classList.add('bg-slate-100', 'border-slate-400'), false); });
        ['dragleave', 'drop'].forEach(eventName => { fileInputLabel.addEventListener(eventName, () => fileInputLabel.classList.remove('bg-slate-100', 'border-slate-400'), false); });
        fileInputLabel.addEventListener('drop', (e) => { const dt = e.dataTransfer; const files = dt.files; if (files.length > 0) handleFileSelect(files[0]); }, false);
        // Reset Button
        resetAllBtn.addEventListener('click', resetAppState);
        // History Navigation
        undoBtn.addEventListener('click', () => { if (!undoBtn.disabled) loadHistoryState(historyIndex - 1); });
        redoBtn.addEventListener('click', () => { if (!redoBtn.disabled) loadHistoryState(historyIndex + 1); });

        // Tool Button Activation
        function deactivateAllToolButtons() { toolButtons.forEach(btn => btn.classList.remove('active')); }
        function hideAllOptionsPanels() { allOptionsSections.forEach(section => section.classList.remove('active')); optionsPlaceholder.style.display = 'block'; }
        toolButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (!originalImage || isProcessing) return;
                const tool = button.dataset.tool;

                // Destroy cropper if switching away from crop tool or deactivating it
                if (activeTool === 'crop' && tool !== 'crop' && cropperInstance) {
                    destroyCropper();
                }
                // Remove text tool cursor if switching away
                if (activeTool === 'text') canvas.classList.remove('text-tool-active');


                if (tool === activeTool) { // Deactivate current tool
                    activeTool = null; deactivateAllToolButtons(); hideAllOptionsPanels();
                    drawCurrentImageToCanvas(); // Redraw without preview
                    return;
                }

                // Activate new tool
                deactivateAllToolButtons(); hideAllOptionsPanels();
                // Don't clear preview here, let the new tool setup handle it
                button.classList.add('active'); activeTool = tool;
                optionsPlaceholder.style.display = 'none';
                const optionsSection = document.getElementById(`options-${tool}`);

                if (optionsSection) {
                    optionsSection.classList.add('active');
                    // Setup tool state and trigger initial preview/UI
                    if (tool === 'resize') {
                        resizeWidthInput.value = currentWidth; resizeHeightInput.value = currentHeight;
                        if (resizeWidthInput.value) updateResizePreview(); // Trigger preview
                    } else if (tool === 'crop') {
                        initializeCropper(); // Initialize Cropper.js
                    } else if (tool === 'border') {
                        updateBorderPreview(); // Trigger preview
                    } else if (tool === 'text') {
                        canvas.classList.add('text-tool-active'); // Add cursor
                        updateTextPreview(); // Trigger preview
                    } else if (tool === 'adjust') {
                        updateAdjustmentPreview(); // Trigger preview
                    } else {
                        // Ensure canvas is visible if switching to a non-cropper tool
                        if (canvas.style.display === 'none') {
                            canvas.style.display = 'block';
                            cropperImage.style.display = 'none';
                            if (currentImage) drawCurrentImageToCanvas(); // Redraw if needed
                        }
                    }
                } else {
                    console.warn(`Options panel for tool "${tool}" not found.`);
                    optionsPlaceholder.style.display = 'block'; activeTool = null;
                    // Ensure canvas is visible if options panel fails
                    if (canvas.style.display === 'none') {
                        canvas.style.display = 'block';
                        cropperImage.style.display = 'none';
                        if (currentImage) drawCurrentImageToCanvas();
                    }
                }
            });
        });

        // --- Tool Implementations ---

        // -- Resize --
        function updateResizePreview() { /* ... (no changes) ... */ if (!currentImage || activeTool !== 'resize' || isProcessing) return; const newWidth = parseInt(resizeWidthInput.value, 10); const newHeight = parseInt(resizeHeightInput.value, 10); if (isNaN(newWidth) || isNaN(newHeight) || newWidth <= 0 || newHeight <= 0) { drawCurrentImageToCanvas(); return; } updateImageDetails(newWidth, newHeight); ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.imageSmoothingQuality = 'high'; ctx.imageSmoothingEnabled = true; try { ctx.drawImage(currentImage, 0, 0, newWidth, newHeight); } catch (e) { console.error("Error drawing resize preview:", e); drawCurrentImageToCanvas(); } }
        resizeWidthInput.addEventListener('input', () => { if (resizeAspectRatioCheckbox.checked && currentAspectRatio > 0) { const newWidth = parseInt(resizeWidthInput.value, 10); if (!isNaN(newWidth) && newWidth > 0) resizeHeightInput.value = Math.round(newWidth / currentAspectRatio); else resizeHeightInput.value = ''; } debounce(updateResizePreview, 250); });
        resizeHeightInput.addEventListener('input', () => { if (resizeAspectRatioCheckbox.checked && currentAspectRatio > 0) { const newHeight = parseInt(resizeHeightInput.value, 10); if (!isNaN(newHeight) && newHeight > 0) resizeWidthInput.value = Math.round(newHeight * currentAspectRatio); else resizeWidthInput.value = ''; } debounce(updateResizePreview, 250); });
        resizeAspectRatioCheckbox.addEventListener('change', () => { if (resizeAspectRatioCheckbox.checked && currentAspectRatio > 0) { const newWidth = parseInt(resizeWidthInput.value, 10); if (!isNaN(newWidth) && newWidth > 0) { resizeHeightInput.value = Math.round(newWidth / currentAspectRatio); debounce(updateResizePreview, 250); } } });
        applyResizeBtn.addEventListener('click', () => { if (!currentImage || isProcessing) return; const newWidth = parseInt(resizeWidthInput.value, 10); const newHeight = parseInt(resizeHeightInput.value, 10); if (isNaN(newWidth) || isNaN(newHeight) || newWidth <= 0 || newHeight <= 0) { showMessage('Invalid dimensions.', 'error'); return; } if (newWidth === currentWidth && newHeight === currentHeight) { showMessage('Dimensions unchanged.', 'info'); return; } showLoading(true); const tempCanvas = document.createElement('canvas'); const tempCtx = tempCanvas.getContext('2d'); tempCanvas.width = newWidth; tempCanvas.height = newHeight; tempCtx.imageSmoothingQuality = 'high'; tempCtx.imageSmoothingEnabled = true; tempCtx.drawImage(currentImage, 0, 0, newWidth, newHeight); updateCurrentImageFromDataURL(tempCanvas.toDataURL('image/png'), () => showMessage('Resize applied.', 'success')); });

        // -- Crop (Using Cropper.js) --
        cropAspectBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const ratio = btn.dataset.ratio;
                setCropperAspectRatio(ratio);
            });
        });
        applyCropBtn.addEventListener('click', () => {
            if (!cropperInstance || isProcessing) return;
            showLoading(true);
            try {
                // Get cropped canvas from Cropper.js
                const croppedCanvas = cropperInstance.getCroppedCanvas({
                    // Options to maintain quality if possible
                    // fillStyle: '#fff', // Optional background for transparent images
                    // imageSmoothingEnabled: true,
                    // imageSmoothingQuality: 'high',
                });

                if (!croppedCanvas) {
                    throw new Error("Failed to get cropped canvas.");
                }

                // Update the main image state
                updateCurrentImageFromDataURL(croppedCanvas.toDataURL('image/png'), () => {
                    showMessage('Crop applied.', 'success');
                    // No need to destroy cropper here, updateCurrentImageFromDataURL handles it
                });
            } catch (error) {
                console.error("Error applying crop:", error);
                showMessage("Failed to apply crop.", "error");
                showLoading(false);
                // Optionally destroy cropper on error?
                // destroyCropper();
            }
        });
        cancelCropBtn.addEventListener('click', () => {
            if (cropperInstance) {
                destroyCropper();
                // Optionally deactivate the tool button
                activeTool = null;
                deactivateAllToolButtons();
                hideAllOptionsPanels();
            }
        });


        // -- Rotate --
        function applyRotation(degrees) { /* ... (no changes, uses updateCurrentImageFromDataURL) ... */ if (!currentImage || isProcessing) return; showLoading(true); setTimeout(() => { try { const rad = degrees * Math.PI / 180; const sin = Math.sin(rad); const cos = Math.cos(rad); const newWidth = Math.abs(currentWidth * cos) + Math.abs(currentHeight * sin); const newHeight = Math.abs(currentWidth * sin) + Math.abs(currentHeight * cos); const tempCanvas = document.createElement('canvas'); const tempCtx = tempCanvas.getContext('2d'); tempCanvas.width = Math.round(newWidth); tempCanvas.height = Math.round(newHeight); tempCtx.translate(tempCanvas.width / 2, tempCanvas.height / 2); tempCtx.rotate(rad); tempCtx.drawImage(currentImage, -currentWidth / 2, -currentHeight / 2, currentWidth, currentHeight); updateCurrentImageFromDataURL(tempCanvas.toDataURL('image/png'), () => showMessage(`Rotated ${degrees}°`, 'success')); } catch (error) { console.error("Error during rotation:", error); showMessage("Failed rotation.", "error"); showLoading(false); } }, 10); }
        rotateLeftBtn.addEventListener('click', () => applyRotation(-90));
        rotateRightBtn.addEventListener('click', () => applyRotation(90));

        // -- Flip --
        function applyFlip(direction) { /* ... (no changes, uses updateCurrentImageFromDataURL) ... */ if (!currentImage || isProcessing) return; showLoading(true); setTimeout(() => { try { const tempCanvas = document.createElement('canvas'); const tempCtx = tempCanvas.getContext('2d'); tempCanvas.width = currentWidth; tempCanvas.height = currentHeight; tempCtx.translate(direction === 'horizontal' ? tempCanvas.width : 0, direction === 'vertical' ? tempCanvas.height : 0); tempCtx.scale(direction === 'horizontal' ? -1 : 1, direction === 'vertical' ? -1 : 1); tempCtx.drawImage(currentImage, 0, 0, currentWidth, currentHeight); updateCurrentImageFromDataURL(tempCanvas.toDataURL('image/png'), () => showMessage(`Flipped ${direction}ly`, 'success')); } catch (error) { console.error("Error during flip:", error); showMessage("Failed flip.", "error"); showLoading(false); } }, 10); }
        flipHorizontalBtn.addEventListener('click', () => applyFlip('horizontal'));
        flipVerticalBtn.addEventListener('click', () => applyFlip('vertical'));


        // -- Adjustments --
        function updateAdjustmentPreview() { /* ... (no changes) ... */ if (!currentImage || isProcessing || activeTool !== 'adjust') return; drawCurrentImageToCanvas(); }
        function resetAdjustmentSliders(redraw = true) { /* ... (no changes) ... */ brightnessSlider.value = 100; contrastSlider.value = 100; saturationSlider.value = 100; grayscaleSlider.value = 0; sepiaSlider.value = 0; blurSlider.value = 0; brightnessValue.textContent = '100'; contrastValue.textContent = '100'; saturationValue.textContent = '100'; grayscaleValue.textContent = '0'; sepiaValue.textContent = '0'; blurValue.textContent = '0'; if (redraw && currentImage) drawCurrentImageToCanvas(); }
        [brightnessSlider, contrastSlider, saturationSlider, grayscaleSlider, sepiaSlider, blurSlider].forEach(slider => { slider.addEventListener('input', (e) => { const valueSpanId = `${e.target.id.split('-')[0]}-value`; document.getElementById(valueSpanId).textContent = e.target.value; debounce(updateAdjustmentPreview, 50); }); });
        applyAdjustBtn.addEventListener('click', () => { /* ... (no changes, uses updateCurrentImageFromDataURL) ... */ if (!currentImage || isProcessing) return; const currentFilters = [`brightness(${brightnessSlider.value}%)`, `contrast(${contrastSlider.value}%)`, `saturate(${saturationSlider.value}%)`, `grayscale(${grayscaleSlider.value}%)`, `sepia(${sepiaSlider.value}%)`, `blur(${blurSlider.value}px)`].join(' '); const isDefault = brightnessSlider.value == 100 && contrastSlider.value == 100 && saturationSlider.value == 100 && grayscaleSlider.value == 0 && sepiaSlider.value == 0 && blurSlider.value == 0; if (isDefault) { showMessage('No adjustments applied.', 'info'); return; } showLoading(true); const tempCanvas = document.createElement('canvas'); const tempCtx = tempCanvas.getContext('2d'); tempCanvas.width = currentWidth; tempCanvas.height = currentHeight; tempCtx.filter = currentFilters; tempCtx.drawImage(currentImage, 0, 0, currentWidth, currentHeight); updateCurrentImageFromDataURL(tempCanvas.toDataURL('image/png'), () => showMessage('Adjustments applied.', 'success')); });
        resetAdjustBtn.addEventListener('click', () => resetAdjustmentSliders(true));


        // -- Border --
        function updateBorderPreview() { /* ... (no changes) ... */ if (!currentImage || isProcessing || activeTool !== 'border') return; drawCurrentImageToCanvas(); }
        [borderWidthInput, borderColorInput].forEach(input => { input.addEventListener('input', () => debounce(updateBorderPreview, 100)); });
        applyBorderBtn.addEventListener('click', () => { /* ... (no changes, uses updateCurrentImageFromDataURL) ... */ if (!currentImage || isProcessing) return; const borderWidth = parseInt(borderWidthInput.value, 10); const borderColor = borderColorInput.value; if (isNaN(borderWidth) || borderWidth < 0) { showMessage('Invalid border width.', 'error'); return; } if (borderWidth === 0) { showMessage('Border width is zero.', 'info'); return; } showLoading(true); const tempCanvas = document.createElement('canvas'); const tempCtx = tempCanvas.getContext('2d'); const newWidth = currentWidth + borderWidth * 2; const newHeight = currentHeight + borderWidth * 2; tempCanvas.width = newWidth; tempCanvas.height = newHeight; tempCtx.fillStyle = borderColor; tempCtx.fillRect(0, 0, newWidth, newHeight); tempCtx.drawImage(currentImage, borderWidth, borderWidth, currentWidth, currentHeight); updateCurrentImageFromDataURL(tempCanvas.toDataURL('image/png'), () => showMessage('Border applied.', 'success')); });


        // -- Text Tool (Enhanced) --
        function drawText(targetCtx, text, canvasWidth, canvasHeight) {
            const lines = text.split('\n');
            if (!lines.length || !text) return; // Also check if text is empty

            const fontSize = parseInt(textSizeInput.value, 10) || 30;
            const fontFamily = textFontFamilySelect.value || 'Arial, sans-serif';
            const isBold = textBoldCheckbox.checked;
            const isItalic = textItalicCheckbox.checked;
            const color = textColorInput.value;
            const opacity = parseFloat(textOpacitySlider.value) || 0.7;
            const align = textAlignSelect.value || 'left'; // Default left for X/Y coords
            const rotation = parseInt(textRotationInput.value, 10) || 0;
            const rotationRad = rotation * Math.PI / 180;
            const x = parseInt(textXInput.value, 10) || 0; // Get X from input
            const y = parseInt(textYInput.value, 10) || 0; // Get Y from input

            let fontStyle = isItalic ? 'italic' : 'normal';
            let fontWeight = isBold ? 'bold' : 'normal';
            targetCtx.font = `${fontStyle} ${fontWeight} ${fontSize}px ${fontFamily}`;
            targetCtx.fillStyle = color;
            targetCtx.globalAlpha = opacity;
            targetCtx.textAlign = align;
            targetCtx.textBaseline = 'top'; // Use top baseline for easier X/Y positioning

            const lineHeight = fontSize * 1.2;

            targetCtx.save();
            targetCtx.translate(x, y); // Move origin to the specified X, Y (top-left)
            targetCtx.rotate(rotationRad); // Rotate context around the new origin

            // Draw each line relative to the (rotated) origin
            for (let i = 0; i < lines.length; i++) {
                targetCtx.fillText(lines[i], 0, i * lineHeight); // Draw at (0, N*lineHeight) relative to origin
            }

            targetCtx.restore(); // Restore context state
            targetCtx.globalAlpha = 1.0; // Reset global alpha
        }

        function updateTextPreview() {
            if (!currentImage || isProcessing || activeTool !== 'text') return;
            drawCurrentImageToCanvas(); // Redraw with text preview
        }

        // Canvas click listener for text positioning
        canvas.addEventListener('click', (e) => {
            if (activeTool !== 'text' || isProcessing || cropperInstance) return; // Only active for text tool when not cropping

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;    // relationship bitmap vs. element for X
            const scaleY = canvas.height / rect.height;  // relationship bitmap vs. element for Y

            // Calculate click coordinates relative to the canvas's internal resolution
            const canvasX = Math.round((e.clientX - rect.left) * scaleX);
            const canvasY = Math.round((e.clientY - rect.top) * scaleY);

            // Update the input fields
            textXInput.value = canvasX;
            textYInput.value = canvasY;

            // Trigger preview update
            updateTextPreview();
        });


        textOpacitySlider.addEventListener('input', (e) => { textOpacityValue.textContent = parseFloat(e.target.value).toFixed(2); debounce(updateTextPreview, 100); });
        // Add listeners for all text controls
        [textInput, textFontFamilySelect, textSizeInput, textBoldCheckbox, textItalicCheckbox,
            textColorInput, textAlignSelect, textRotationInput, textXInput, textYInput /*, textPositionSelect - removed */].forEach(input => {
                input.addEventListener('input', () => debounce(updateTextPreview, 100));
                input.addEventListener('change', () => debounce(updateTextPreview, 100)); // For selects/checkboxes/numbers
            });

        applyTextBtn.addEventListener('click', () => {
            if (!currentImage || isProcessing) return;
            const text = textInput.value;
            if (!text) { showMessage('Please enter text to apply.', 'info'); return; }
            showLoading(true);
            const tempCanvas = document.createElement('canvas'); const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = currentWidth; tempCanvas.height = currentHeight;
            tempCtx.drawImage(currentImage, 0, 0, currentWidth, currentHeight);
            drawText(tempCtx, text, currentWidth, currentHeight); // Draw text on top
            updateCurrentImageFromDataURL(tempCanvas.toDataURL('image/png'), () => showMessage('Text applied.', 'success'));
        });


        // -- Export / Download --
        function updateEstimatedSize() { /* ... (no changes) ... */ if (!currentImage || isProcessing) { estimatedSizeSpan.textContent = 'N/A'; return; } setTimeout(() => { if (!currentImage) return; const format = convertFormatSelect.value; const quality = parseInt(convertQualitySlider.value, 10) / 100; let dataUrl; try { const tempCanvas = document.createElement('canvas'); const tempCtx = tempCanvas.getContext('2d'); tempCanvas.width = currentWidth; tempCanvas.height = currentHeight; tempCtx.drawImage(currentImage, 0, 0, currentWidth, currentHeight); if (format === 'image/png') dataUrl = tempCanvas.toDataURL('image/png'); else if (format === 'image/jpeg') dataUrl = tempCanvas.toDataURL('image/jpeg', quality); else if (format === 'image/webp') dataUrl = tempCanvas.toDataURL('image/webp', webpLosslessCheckbox.checked ? 1.0 : quality); else { estimatedSizeSpan.textContent = 'Error'; return; } const base64Length = dataUrl.length - dataUrl.indexOf(',') - 1; const approxBytes = Math.ceil(base64Length * 0.75); estimatedSizeSpan.textContent = `~ ${formatBytes(approxBytes)}`; } catch (error) { console.error("Size estimation error:", error); estimatedSizeSpan.textContent = 'Error'; } }, 10); }
        convertFormatSelect.addEventListener('change', () => { const format = convertFormatSelect.value; const isLossy = format === 'image/jpeg' || (format === 'image/webp' && !webpLosslessCheckbox.checked); qualityOptionDiv.classList.toggle('hidden', !isLossy); webpOptionsDiv.classList.toggle('hidden', format !== 'image/webp'); debounce(updateEstimatedSize, 200); });
        webpLosslessCheckbox.addEventListener('change', () => { convertFormatSelect.dispatchEvent(new Event('change')); });
        convertQualitySlider.addEventListener('input', (e) => { qualityValue.textContent = e.target.value; debounce(updateEstimatedSize, 200); });
        downloadBtn.addEventListener('click', () => { /* ... (no changes) ... */ if (!currentImage || isProcessing) { showMessage('No image to download.', 'info'); return; } const format = convertFormatSelect.value; const quality = parseInt(convertQualitySlider.value, 10) / 100; const filename = (downloadFilenameInput.value || 'edited-image').replace(/[^a-z0-9_\-.]/gi, '_'); let finalFilename = filename; let fileExtension = ''; let dataUrl; try { showLoading(true); const finalCanvas = document.createElement('canvas'); const finalCtx = finalCanvas.getContext('2d'); finalCanvas.width = currentWidth; finalCanvas.height = currentHeight; finalCtx.drawImage(currentImage, 0, 0, currentWidth, currentHeight); if (format === 'image/png') { dataUrl = finalCanvas.toDataURL('image/png'); fileExtension = '.png'; } else if (format === 'image/jpeg') { dataUrl = finalCanvas.toDataURL('image/jpeg', quality); fileExtension = '.jpg'; } else if (format === 'image/webp') { dataUrl = finalCanvas.toDataURL('image/webp', webpLosslessCheckbox.checked ? 1.0 : quality); fileExtension = '.webp'; } else { showMessage('Unsupported format.', 'error'); showLoading(false); return; } if (!finalFilename.toLowerCase().endsWith(fileExtension)) finalFilename += fileExtension; const link = document.createElement('a'); link.href = dataUrl; link.download = finalFilename; document.body.appendChild(link); link.click(); document.body.removeChild(link); showMessage('Download started.', 'success'); } catch (error) { console.error("Download Error:", error); showMessage(`Error generating image: ${error.message}`, 'error'); } finally { showLoading(false); } });

        // --- Initial Setup ---
        resetAppState(); // Initialize the UI correctly

    </script>
</body>

</html>